name: OneAndTwoShop Dev CI

# ===============================================================
# ğŸ“Œ DEV CIï¼ˆééƒ¨ç½²ï¼‰
# é€™æ”¯å·¥ä½œæµè² è²¬ã€Œé–‹ç™¼éšæ®µçš„è‡ªå‹•åŒ–å»ºç½®èˆ‡å“è³ªæª¢æŸ¥ã€
#
# ç”¨é€”ï¼š
# 1. é–‹ç™¼è€…ä¸Šå‚³ç¨‹å¼ç¢¼å¾Œï¼Œç«‹å³åŸ·è¡Œè‡ªå‹•åŒ–å»ºç½®ï¼ˆCIï¼‰
# 2. åœ¨ Code Review ä¹‹å‰å…ˆé©—è­‰ç¨‹å¼ç¢¼å¯å¦æ­£å¸¸ Build
# 3. æ¸¬è©¦ Multi-module Mavenã€Docker build æ˜¯å¦æ­£å¸¸
# 4. åªä¸Šå‚³ Dev ç‰ˆæœ¬ Docker Imageï¼ˆæ–¹ä¾¿æ—¥å¾Œ Dev ç’°å¢ƒéƒ¨ç½²ï¼‰
#
# â—é€™è£¡ä¸åšéƒ¨ç½²ï¼ˆé CDï¼‰
# ===============================================================

on:
  push:
    branches: [ "dev" ]   # ğŸ”¥ åªæœ‰ dev åˆ†æ”¯çš„æ¨é€æœƒè§¸ç™¼ CI
  pull_request:
    branches: [ "dev" ]   # ğŸ”¥ PR åˆ° dev æ™‚æœƒåŸ·è¡Œ CIï¼ˆæ–¹ä¾¿ Code Reviewï¼‰

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

      # -----------------------------------------------------------
      # 1ï¸âƒ£ Checkout åŸå§‹ç¢¼ï¼Œä¾›å¾ŒçºŒå»ºç½®ä½¿ç”¨
      # -----------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # 2ï¸âƒ£ å®‰è£ Java 17ï¼šSpring Boot + Maven å¿…å‚™ç’°å¢ƒ
      # -----------------------------------------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # -----------------------------------------------------------
      # 3ï¸âƒ£ Maven Buildï¼ˆè·³éæ¸¬è©¦ï¼‰
      # ç›®çš„ï¼š
      # - ç¢ºèªç¨‹å¼ç¢¼èƒ½æ­£å¸¸ Build
      # - é©—è­‰ multi-module ä¾è³´æ˜¯å¦æ­£å¸¸
      #
      # Code Review ä¹‹å‰æœ€é—œéµçš„ CI æ­¥é©Ÿ
      # -----------------------------------------------------------
      - name: Build with Maven
        run: mvn -q -B -DskipTests clean package

      # -----------------------------------------------------------
      # 4ï¸âƒ£ ç™»å…¥ GitHub Container Registryï¼ˆGHCRï¼‰
      # ç”¨é€”ï¼š
      # - å°‡ Dev ç‰ˆ Docker image ä¸Šå‚³ï¼ˆå¯ä¾›æœªä¾† Dev ç’°å¢ƒéƒ¨ç½²ï¼‰
      # -----------------------------------------------------------
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------------
      # 5ï¸âƒ£ Build Dev ç‰ˆæœ¬ Docker Images
      # æ­¤æ­¥é©Ÿç”¨æ–¼é©—è­‰ Docker æ˜¯å¦èƒ½æˆåŠŸæ‰“åŒ…
      # ä¸¦ç”¢ç”Ÿ :dev tagï¼Œä¾›æ—¥å¾Œ Dev ä¼ºæœå™¨æ‰‹å‹•æˆ–è‡ªå‹•éƒ¨ç½²ä½¿ç”¨
      # -----------------------------------------------------------
      - name: Build Docker images
        run: |
          docker build -t ghcr.io/${{ github.repository_owner }}/oneshop-user:dev --target user .
          docker build -t ghcr.io/${{ github.repository_owner }}/oneshop-product:dev --target product .
          docker build -t ghcr.io/${{ github.repository_owner }}/oneshop-order:dev --target order .

      # -----------------------------------------------------------
      # 6ï¸âƒ£ å°‡ Dev ç‰ˆ Images æ¨ä¸Š GHCRï¼ˆééƒ¨ç½²ï¼‰
      # ç›®çš„ï¼š
      # - æä¾› Dev ç’°å¢ƒå¾ŒçºŒéƒ¨ç½²å¯ä½¿ç”¨çš„æœ€æ–° Image
      # -----------------------------------------------------------
      - name: Push Docker images
        run: |
          docker push ghcr.io/${{ github.repository_owner }}/oneshop-user:dev
          docker push ghcr.io/${{ github.repository_owner }}/oneshop-product:dev
          docker push ghcr.io/${{ github.repository_owner }}/oneshop-order:dev
